<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Covoit SantÃ© â€” Optimiseur de RDV</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">ðŸš‘ðŸŒ±</div>
      <div>
        <h1>Covoit SantÃ©</h1>
        <p class="subtitle">Optimiser les rendez-vous pour favoriser le covoiturage</p>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>Choisir la journÃ©e Ã  optimiser</h2>
      <form method="post" class="form-grid">
        <label>
          <span>Jour</span>
          <input type="date" name="date"
       min="2022-01-01" max="2022-12-31"
       value="{{ selected_date or default_date }}" required>

        </label>
        <label>
          <span>Distance aller jusqu'au site (km)</span>
          <input type="number" name="site_km" step="0.1" min="0" value="{{ site_km or defaults.site_km }}">
        </label>
        <div class="hints">
          <small>HypothÃ¨ses : rayon covoit = {{ defaults.max_dist }} km, Ã©cart horaire â‰¤ {{ defaults.max_dt }} min, facteur d'Ã©mission â‰ˆ {{ defaults.emission }} kgCOâ‚‚/km.</small>
        </div>
        <button type="submit" class="primary">Optimiser les RDV</button>
      </form>
      {% if error %}
        <div class="alert">
          <strong>Oups â€”</strong> {{ error }}
        </div>
      {% endif %}
    </section>

    {% if results %}
    <section class="grid-2">
      <div class="card kpis">
        <h2>Bilan de la journÃ©e</h2>
        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-value">{{ results.count_rdv }}</div>
            <div class="kpi-label">RDV ce jour</div>
          </div>
          <div class="kpi">
            <div class="kpi-value">{{ results.count_pairs_before }}</div>
            <div class="kpi-label">Paires (avant)</div>
          </div>
          <div class="kpi">
            <div class="kpi-value">{{ results.count_pairs_after }}</div>
            <div class="kpi-label">Paires (aprÃ¨s)</div>
          </div>
          <div class="kpi">
            <div class="kpi-value {{ 'pos' if results.delta_pairs>=0 else 'neg' }}">{{ results.delta_pairs | string }}</div>
            <div class="kpi-label">Gain de paires</div>
          </div>
        </div>
        <div class="kpi-row">
          <div class="kpi">
            <div class="kpi-value">{{ results.saved_km }}</div>
            <div class="kpi-label">km Ã©vitÃ©s (â‰ˆ)</div>
          </div>
          <div class="kpi">
            <div class="kpi-value">{{ results.saved_kg }}</div>
            <div class="kpi-label">kgCOâ‚‚ Ã©vitÃ©s (â‰ˆ)</div>
          </div>
        </div>
      </div>

      <div class="card plots">
        <h2>Avant / AprÃ¨s</h2>
        <div class="plots-row">
          <figure>
            <img src="{{ url_for('static', filename=results.before_plot) }}" alt="Avant">
            <figcaption>Avant optimisation</figcaption>
          </figure>
          <figure>
            <img src="{{ url_for('static', filename=results.after_plot) }}" alt="AprÃ¨s">
            <figcaption>AprÃ¨s optimisation</figcaption>
          </figure>
        </div>
        <small>RepÃ¨res 3D : longitude, latitude, heure (min). Couleurs par motif.</small>
      </div>
    </section>

    <section class="card">
      <h2>Couples de covoiturage (aprÃ¨s optimisation)</h2>
      {% if results.pairs_after|length == 0 %}
        <p>Aucun couple admissible selon les critÃ¨res.</p>
      {% else %}
        <div class="table-wrapper">
          <table>
            <thead>
                <tr>
                  <th>Trajet</th>
                  <th>NIP 1</th><th>NIP 2</th>
                  <th>Motif 1</th><th>Motif 2</th>
                  <th>Heure 1</th><th>Heure 2</th>
                  <th>Î” (min)</th><th>Distance (km)</th>
                </tr>
              </thead>
            <thead>
              <tr>
                <th>NIP 1</th><th>NIP 2</th>
                <th>Motif 1</th><th>Motif 2</th>
                <th>Heure 1</th><th>Heure 2</th>
                <th>Î” (min)</th><th>Distance (km)</th>
              </tr>
            </thead>
            <tbody>
                {% for r in results.pairs_after %}
                <tr>
                  <td>{{ r.Trajet }}</td>
                  <td>{{ r.NIP_1 }}</td>
                  <td>{{ r.NIP_2 }}</td>
                  <td>{{ r.Motif_1 }}</td>
                  <td>{{ r.Motif_2 }}</td>
                  <td>{{ r.Heure_1 }}</td>
                  <td>{{ r.Heure_2 }}</td>
                  <td>{{ r.Delta_min }}</td>
                  <td>{{ r.Distance_km }}</td>
                </tr>
                {% endfor %}
              </tbody>
          </table>
        </div>
      {% endif %}
    </section>
    {% endif %}
  </main>

  <footer>
    <span>Â© Covoit SantÃ© â€” prototype</span>
  </footer>
</body>
</html>
